#!/usr/bin/env ruby
require File.join( File.dirname(__FILE__), '../config/environment' )
# Parse the command line arguments
require 'optparse'
excludes = []
OptionParser.new do |opts|
  opts.banner = "Usage: #{File.basename($0)} [options] [files or directories]"

  opts.separator ""
  opts.separator "VimMate #{VimMate::VERSION}: Vim graphical add-on"
  opts.separator "Copyright (C) 2006 Guillaume Benny"
  opts.separator ""
  opts.separator "If files or directories are omitted, the current directory is shown"

  opts.on("-x",
          "--exclude file1,file2,file3",
          Array,
          "Comma separated list of files or directory to exclude.") do |list|
    excludes = list
  end

  opts.on_tail("-h", "--help", "Show this help screen") do |string|
    puts opts
    exit
  end
end.parse!


# Ignore patterns from .vimmate_ignore
local_ignore_file = File.expand_path('.vimmate_ignore')
if File.exists?(local_ignore_file)
  File.open(local_ignore_file) do |f|
    while line = f.gets 
      line.chomp!.strip!
      excludes << line unless line.blank?
    end
  end
end

# We fork to give back the shell to the user, like Vim
fork do
  Thread.abort_on_exception = true

  class VimMateApp < ActiveWindow::Application
    def add_path(path)
      controller[:file_filter].file_tree.add_path(path)
      controller[:file_filter].changed
    end
  end

  PROGRAM_NAME = 'vim_mate'
  app = VimMateApp.new(:title => 'VimMate', :main_window => 'VimMate')

  app.setup
  app.post_setup
  # If there are no files given, add the current directory to the file list.
  # If files are specified on the command line, use them
  if ARGV.empty?
    app.add_path(File.expand_path('.'))
    #window.file_tree.expand_first_row
  else
    ARGV.each do |file|
      path = File.expand_path(file)
      app.add_path(path)
      #window.vim.open(path, :tab)
    end
  end
  app.start


  ## Create the main objects
  #window = VimMate::Window.new

  #excludes.each do |pattern|
  #  window.file_tree.exclude! pattern
  #end

  #window.show



  #window.start
end

